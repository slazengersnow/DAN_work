# CSVインポート機能 - 改善版

このドキュメントでは、月次レポートのCSVインポート機能の使用方法、改善点、およびトラブルシューティングについて説明します。

## 機能概要

CSVインポート機能は以下の機能を提供します：

1. 月次データのテンプレートダウンロード
2. CSVファイルからの月次データのインポート
3. 成功/エラー通知機能
4. デバッグモード（開発者向け）

## インストール方法

この機能はフロントエンドにすでに統合されています。追加のインストール手順は必要ありません。

## 使用方法

### 基本的な使用方法

1. 月次レポート画面の「インポート」ボタンをクリックして、CSVインポートモーダルを開きます
2. 「テンプレートをダウンロード」ボタンをクリックして、CSVテンプレートをダウンロードします
3. ダウンロードしたテンプレートにデータを入力します（Excelなどで編集可能）
4. 「CSVファイルを選択」をクリックして、編集したCSVファイルを選択します
5. ファイルが自動的に解析され、インポート準備が整うと「インポート開始」ボタンが有効になります
6. 「インポート開始」をクリックして、データをインポートします
7. インポートが成功すると成功通知が表示され、モーダルが閉じます

### テンプレートの記入方法

CSVテンプレートには以下の情報を入力します：

- 「年度」行には該当する会計年度を入力（空の場合は現在選択されている年度が使用されます）
- 各月（4月～3月）の列に対応するデータを入力：
  - 従業員数
  - フルタイム従業員数
  - パートタイム従業員数
  - 1級・2級の障がい者数
  - その他障がい者数
  - 1級・2級の障がい者(パートタイム)数
  - その他障がい者(パートタイム)数
  - 法定雇用率

## 新機能・改善点

### 1. ユーザーフィードバックの強化

- 操作結果を明確に示す通知機能を追加
- ダウンロード、インポート成功/失敗などの通知を3秒後に自動的に消える仕様に変更
- 処理中の進捗状況を視覚的に表示

### 2. デバッグモード

開発者向けにデバッグモードを実装しました：

- ブラウザのデベロッパーツールのコンソールで以下のコマンドを実行してデバッグモードを有効化できます：
  ```javascript
  localStorage.setItem('debug_mode', 'true')
  ```
- デバッグモードを無効化するには以下を実行します：
  ```javascript
  localStorage.setItem('debug_mode', 'false')
  ```
- 現在のデバッグモード状態を確認するには以下を実行します：
  ```javascript
  localStorage.getItem('debug_mode')
  ```

デバッグモードでは、以下の詳細なログが出力されます：
- パフォーマンス計測（ファイル読み込み、パース処理、APIリクエストなど）
- データ変換プロセスの詳細
- エラー情報の詳細
- API通信の詳細とタイミング

**注意**: デバッグモードはパフォーマンスに影響する可能性があるため、テストや開発時のみ有効にすることをお勧めします。

### 3. メンテナンス性の向上

- 関数名と変数名を明確で説明的なものに統一
- 機能ごとにモジュール化（通知、ロガー等）
- 拡張しやすいコードベースに改善

## トラブルシューティング

### CSVファイルがインポートできない

1. **CSVファイルの形式を確認**
   - UTF-8エンコードのCSVファイルを使用してください
   - テンプレートの形式（年度行、ヘッダー行）が維持されていることを確認
   - Excelで編集した場合は「CSV（カンマ区切り）」形式で保存してください

2. **データの妥当性を確認**
   - 数値のみを入力してください（文字列が含まれていないか確認）
   - 月の列（4月～3月）に対応するデータが正しく配置されているか確認

3. **サーバーエラー**
   - APIサーバーが正常に動作していることを確認
   - ネットワーク接続を確認
   - 再度ログインして再試行

### エラーメッセージ別の対処法

| エラーメッセージ | 考えられる原因 | 対処法 |
|--------------|------------|-------|
| ファイルの読み込みに失敗しました | ファイルが破損している | 新しくテンプレートをダウンロードして再試行 |
| CSVファイルの解析中にエラーが発生しました | CSVの形式が不正 | 形式を確認し、正しいCSV形式で保存 |
| データの変換に失敗しました | データに不正な値が含まれている | 数値のみが入力されているか確認 |
| インポートするデータが見つかりませんでした | テンプレートが空または情報が不足 | 必要なデータを全て入力 |
| データのインポートに失敗しました | サーバー側のエラー | サーバーの状態を確認し、再試行 |

## 開発者向け情報

### ファイル構成

- `CSVImportModal.tsx` - メインのインポートモーダルコンポーネント
- `ImportNotification.tsx` - 通知コンポーネント
- `DebugLogger.ts` - デバッグログユーティリティ
- `utils.ts` - CSVデータ変換ユーティリティ
- `ImportNotificationEnhancer.css` - 通知のスタイル

### APIエンドポイント

CSVインポート機能は以下のAPIエンドポイントを使用します：

- `GET /api/monthly-reports/:year/:month` - 既存データの確認
- `POST /api/monthly-reports` - 新規データの作成（エンドポイント1）
- `POST /api/monthly-reports/:year/:month` - 新規データの作成（エンドポイント2）
- `PUT /api/monthly-reports/:year/:month` - 既存データの更新

### 将来の拡張

- オフラインサポート（IndexedDBを使用したローカルキャッシュ）
- バッチ処理の最適化によるさらなる高速化
- より詳細なデータ検証と事前チェック
- 部分的なインポート（選択した月のみ）

## 更新履歴

- 2025/05/07: 通知機能、デバッグモード、パフォーマンス改善を追加
- 2025/05/06: CSVインポート機能の基本実装