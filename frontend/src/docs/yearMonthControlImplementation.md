# 年度・月選択コントロール表示制御の実装

このドキュメントでは、ユーザーロールに基づいて年度・月選択コントロールの表示/非表示を制御する機能の実装について説明します。

## 概要

この機能では、管理者ユーザーのみが年度・月選択コントロールを表示し、一般ユーザーには表示されないようになっています。
これにより、一般ユーザーは現在の年月のデータのみを閲覧でき、データの改ざんや過去データの閲覧を防止します。

## 実装コンポーネント

### バックエンド

1. **ミドルウェア**: `yearMonthSelector.js`
   - JWT認証を使用してユーザーロールを確認
   - 表示設定をレスポンスヘッダに追加
   - レスポンスデータにも表示設定を埋め込み

2. **サーバー設定**: `server.js`
   - CORSの設定で`X-Show-Year-Month-Controls`ヘッダーを公開
   - 年度・月選択コントロール表示制御ミドルウェアを適用

3. **ルート設定**:
   - `monthlyReportRoutes.js`: 月次レポートルートにミドルウェアを適用
   - `settingsRoutes.js`: 設定ルートにミドルウェアを適用

### フロントエンド

1. **ハンドラー**: `yearMonthControlsHandler.js`
   - APIレスポンスヘッダーから表示設定を取得
   - APIレスポンスデータから表示設定を取得
   - 設定データから表示設定を取得
   - 表示設定に基づいたスタイルやクラスを提供

2. **スタイル**: `yearMonthControls.css`
   - 表示/非表示を制御するCSSクラス

3. **コンテキスト**: `YearMonthContext.tsx`
   - 表示設定をコンテキストに含める
   - コンテキストを通じて子コンポーネントに表示設定を提供

4. **コンポーネント**:
   - `MonthlyTab.tsx`: 詳細表示ボタンの表示/非表示制御
   - `MonthlyReportDetail.tsx`: 年度選択、新規作成ボタン、編集ボタン、インポートボタンの表示/非表示制御
   - `index.tsx`: 年月選択パネル、更新ボタンの表示/非表示制御

5. **テスト**: `YearMonthVisibilityTest.tsx`
   - 表示設定のテスト用コンポーネント

## 動作フロー

1. ユーザーがログインすると、JWTトークンにユーザーロールが格納されます
2. APIリクエスト時にJWTトークンがサーバーに送信されます
3. サーバーサイドでミドルウェアがロールを確認し、表示設定を決定します
4. レスポンスヘッダーと本文に表示設定が含まれます
5. フロントエンドのハンドラーがこれらの設定を処理し、グローバル状態として保持します
6. 各UIコンポーネントが表示設定に基づいて表示/非表示を切り替えます

## 注意点

- トークンの検証エラーが発生した場合、デフォルトでは表示設定が`false`（非表示）になります
- 表示設定は複数の場所（ヘッダー、データ、設定）から取得できるため、柔軟な実装が可能です
- CSSとインラインスタイルの両方を使用して表示/非表示を制御しています

## テスト方法

テスト用の`YearMonthVisibilityTest.tsx`コンポーネントを使用して、表示設定の動作を確認できます。

1. テストコンポーネントを表示
2. 「表示設定を切り替え」ボタンをクリックして表示/非表示を確認
3. 実際のUIコンポーネントで表示/非表示が正しく動作しているか確認

## 将来の拡張

- 他のUI要素への表示制御の拡張
- より細かい権限管理（特定のユーザーグループごとに異なる表示設定）
- 設定画面からの表示設定管理機能